@using DisciplinarySystem.Application.Helpers
@using DisciplinarySystem.Presentation.Controllers.Epistles.Helpers
@using DisciplinarySystem.Presentation.Controllers.Epistles.ViewModels
@using DisciplinarySystem.Presentation.Models
@model DisciplinarySystem.Application.Epistles.ViewModels.UpdateEpistle



@section Styles{
	<link rel="stylesheet" href="~/css/partials/seach-select-options.css" />
}

@if ( Model.WithSteps && Model.CaseId.HasValue )
{
	var step = new CaseSteps
				{
					ActiveStep = "Epistle" ,
					CaseId = Model.CaseId.Value
				};

	<partial name="_CaseStepsPartial" model="step" />
}



<div class="d-flex justify-content-end mb-3">
	<button type="button" onclick="history.back()" class="btn btn-secondary d-flex align-items-center">
		بازگشت
		<i class="fa fa-angle-left me-2"></i>
	</button>
</div>

<form method="post" enctype="multipart/form-data">
	<input asp-for="WithSteps" hidden />
	<input asp-for="CreateDate" hidden />

	<div class="d-flex flex-column flex-sm-row align-items-sm-center  justify-content-between mb-2">
		<h3 class="mb-sm-0 mb-4">ویرایش نامه</h3>
		<div>
			<div class="row">
				<div class="mb-3 col-md-6">
					<label class="form-label">شماره نامه:</label>
					<input dir="ltr" type="text" asp-for="Id" class="form-control" id="letter-number"
						   readonly>
				</div>
				<div class="mb-3 col-md-6">
					<label class="form-label">تاریخ ثبت:</label>
					<input dir="ltr" value="@Model.CreateDate.ToShamsi()" class="form-control" id="plaintiff-date" readonly>
				</div>
			</div>
		</div>
	</div>
	<section class="card mt-3">

		<div class="row mb-4">
			<div class="col-md-6">
				<h4 class="mt-4">فرستنده:</h4>
				<section class="card">
					<div>
						<div>
							<label class="form-label">سمت:</label>
							<div class="select-container">

								<input value="" onchange="ChangePosition(this , 'sender-option','sender-person')" hidden>
								<div class="select">
									<div class="select-search">
										<input name="select"
											   autocomplete="off"
											   placeholder="جستجو و انتخاب"
											   class="form-control input-select"
											   onkeyup="KeyUp(this)"
											   onkeydown="KeyDown(this)"
											   onclick="ToggleOptions(this)" />
									</div>
								</div>

								<ul class="select-list" id="options">
									@if (Model.Positions != null)
									{
										@foreach (var item in Model.Positions)
										{
											<li class="select-item search-options" onclick="SetOption(this)">
												<div value="@item.Value">@item.Text</div>
											</li>
										}
									}
								</ul>
							</div>
						</div>
						<br />
						<div>
							<label class="form-label">انتخاب شخص:</label>
							<div class="dropdown">
								<select class="form-control" onchange="ChangePerosn(this ,'sender-person')" id="sender-option">
								</select>
							</div>
						</div>
						<br />
						<div>
							<label class="form-label">نام و نام خانوادگی:</label>
							<div>
								<input asp-for="Sender" class="form-control" id="sender-person" />
							</div>
							<span asp-validation-for="Sender"></span>
						</div>
					</div>
				</section>
			</div>

			<div class="col-md-6">
				<h4 class="mt-4">گیرنده:</h4>
				<section class="card  p-3 ">
					<div>
						<div>
							<label class="form-label">سمت:</label>
							<div class="select-container">

								<input value="" onchange="ChangePosition(this , 'reciver-options' , 'reciver-person')" hidden>
								<div class="select">
									<div class="select-search">
										<input name="select"
											   autocomplete="off"
											   placeholder="جستجو و انتخاب"
											   class="form-control input-select"
											   onkeyup="KeyUp(this)"
											   onkeydown="KeyDown(this)"
											   onclick="ToggleOptions(this)" />
									</div>
								</div>

								<ul class="select-list" id="options">
									@if (Model.Positions != null)
									{
										@foreach (var item in Model.Positions)
										{
											<li class="select-item search-options" onclick="SetOption(this)">
												<div value="@item.Value">@item.Text</div>
											</li>
										}
									}
								</ul>
							</div>
						</div>
						<br />
						<div>
							<label class="form-label">انتخاب شخص:</label>
							<div class="dropdown">
								<select id="reciver-options" class="form-control" onchange="ChangePerosn(this , 'reciver-person')">
								</select>
							</div>
						</div>
						<br />
						<div>
							<label class="form-label">نام و نام خانوادگی:</label>
							<div>
								<input asp-for="Reciver" class="form-control" id="reciver-person" />
							</div>
							<span asp-validation-for="Reciver"></span>
						</div>
					</div>
				</section>
			</div>
		</div>
		<div class="row">
			<div class="mb-3 col-md-6">
				<label class="form-label">شماره پرونده مرتبط:</label>
				<input min="1" type="number" asp-for="CaseId" class="form-control">
			</div>
			<div class="mb-3 col-md-6">
				<label class="form-label">شماره شکایت مرتبط:</label>
				<input min="1" type="number" asp-for="ComplaintId" class="form-control">
			</div>

			<div class="mb-3 col-md-6">
				<label class="form-label">موضوع نامه:</label>
				<input type="text" asp-for="Subject" class="form-control">
				<span class="text-danger" asp-validation-for="Subject"></span>
			</div>
			<div class="mb-3 col-md-6">
				<label class="form-label">نوع نامه:</label>
				<div class="dropdown">
					<select type="text" asp-for="Type" class="form-control" asp-items="@EpistleTypes.GetSelectedTypes()"></select>
				</div>
				<span class="text-danger" asp-validation-for="Type"></span>
			</div>
		</div>
		<div class="mb-3">
			<label class="form-label">شرح نامه:</label>
			<textarea asp-for="Description" class="form-control" rows="5"></textarea>
			<span asp-validation-for="Description" class="text-danger"></span>
		</div>
		<div class="mt-3">
			<label for="file">
				<span role="button" id="file-btn" class="btn btn--upload-file">
					بارگذاری مستندات
				</span>
				<input type="file" asp-for="NewDocuments" id="file" hidden multiple />
			</label>
		</div>
	</section>

	<div class="mt-3 text-center">
		<button class="btn btn--submit">
			ثبت
		</button>
	</div>

</form>
@if ( Model.CurrentDocuments != null && Model.CurrentDocuments.Count() > 0 )
{
	<div>
		<h4 class="mt-4">مدارک:</h4>
		<div class="table-overflow">
			<div class="table ">
				<table class="table text-center" width="100%">
					<thead>
						<tr>
							<th>عنوان مدرک</th>
							<th>تاریخ ارسال</th>
							<th>عملیات</th>
						</tr>
					</thead>
					<tbody>
						@foreach ( var item in Model.CurrentDocuments )
						{
							<tr>
								<td>@item.Name</td>
								<td>@item.CreateDate.ToShamsi()</td>
								<td>
									<div class="table__action">
										<a class="btn btn--show mx-2" asp-action="Download" asp-route-fileName="@item.Name" asp-route-file="@item.File">
											<i class="fa fa-download"></i>
										</a>
										<button type="button" class="btn btn--delete" onclick="Delete('/Epistle/RemoveFile/@item.Id' , 'فایل')"><i class="fa fa-trash"></i></button>

									</div>
								</td>
							</tr>
						}

					</tbody>
				</table>
			</div>
		</div>
	</div>
}
<div class="backdrop"></div>

@section Scripts{
	<partial name="_ValidationScriptsPartial" />
	<script src="~/js/utility/removeAlert.js"></script>
	<script src="~/js/utility/showFiles.js"></script>

	<script src="~/js/partials/seach-select-box.js"></script>
	<script>

		function ChangePerosn(select, id) {
			const input = document.getElementById(id);
			input.value = select.value;
		}

		function ChangePosition(selectOption, id, inputId) {
			const options = document.getElementById(id);
			const input = document.getElementById(inputId);
			const selected = selectOption.value;


			$.ajax({
				url: `/Epistle/GetPositions/${selected}`,
				type: "GET",
				success: function (info) {
					if (info.exists && info.data.length > 0) {
						options.setAttribute("style", "color:black");
						Array.from(options.children).forEach(item => item.remove());
						Array.from(info.data).forEach(item => {
							let opt = document.createElement("option");
							opt.value = item.text;
							opt.text = item.text;
							options.appendChild(opt);
						});
						input.value = Array.from(info.data)[0].text;
					}
					else if (info.exists) {
						Array.from(options.children).forEach(item => item.remove());
						let opt = document.createElement("option");
						options.appendChild(opt);

					}
				}
			})
		}
	</script>
}